<!DOCTYPE html>
<html lang="pt-pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novo Orçamento • OrçaFácil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Previne zoom no iOS */
        input,
        select,
        textarea {
            font-size: 16px !important;
        }

        @media (min-width: 768px) {

            input,
            select,
            textarea {
                font-size: 0.875rem !important;
            }
        }
    </style>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>

<body class="bg-[#F0F4F8] text-slate-800 min-h-screen flex flex-col">

    <header class="w-full px-8 py-6 flex justify-between items-center bg-transparent">
        <a href="dashboard.html"
            class="flex items-center gap-2 text-slate-800 hover:opacity-80 transition-opacity group">
            <div
                class="bg-blue-600 text-white p-1.5 rounded-lg group-hover:scale-110 transition-transform shadow-lg shadow-blue-500/20">
                <i class="ph-bold ph-hexagon text-xl"></i>
            </div>
            <span class="font-bold text-xl tracking-tight text-blue-900">OrçaFácil</span>
        </a>
    </header>

    <main class="flex-1 flex flex-col items-center justify-center p-4 pb-32">
        <h1 class="text-2xl md:text-3xl font-bold text-slate-900 mb-8 flex items-center gap-2">
            <i class="ph-duotone ph-file-plus text-blue-600"></i> Criar Novo Orçamento
        </h1>

        <div class="bg-white w-full max-w-4xl p-8 rounded-xl shadow-xl shadow-slate-200/60 border border-slate-100">
            <form id="form-criar-completo" class="space-y-8">
                <!-- Seção Cliente -->
                <!-- Seção Cliente (Redesenhada & Otimizada) -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-6">
                    <div
                        class="p-5 md:p-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 border-b border-slate-100">
                        <div class="flex items-center gap-3">
                            <div class="flex-shrink-0 text-blue-600">
                                <i class="ph-duotone ph-user text-2xl"></i>
                            </div>
                            <h3 class="text-sm font-bold text-slate-800 leading-tight uppercase tracking-wide">
                                Informações do<br>Cliente
                            </h3>
                        </div>
                        <button type="button" onclick="toggleNovoCliente()" id="btn-novo-cliente-text"
                            class="w-full sm:w-auto bg-blue-50 hover:bg-blue-100 text-blue-600 hover:text-blue-700 text-xs font-bold px-4 py-2 rounded-lg transition-all flex items-center justify-center gap-2 border border-blue-100">
                            <i class="ph-bold ph-plus-circle text-lg"></i> Novo Cliente
                        </button>
                    </div>

                    <div class="p-5 md:p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-2 order-1">
                            <label
                                class="block text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-wider">Selecione
                                o Cliente *</label>
                            <div class="relative group">
                                <span
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-blue-500 transition-colors z-10">
                                    <i class="ph-bold ph-magnifying-glass text-lg"></i>
                                </span>
                                <select id="select-cliente"
                                    class="w-full pl-12 pr-10 py-3 bg-white border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 appearance-none transition-all cursor-pointer text-sm font-medium text-slate-700 hover:border-blue-300">
                                    <option value="">Selecione um cliente...</option>
                                </select>
                                <i
                                    class="ph-bold ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>
                        <div class="order-3 md:order-2">
                            <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-wider">Data
                                de Validade</label>
                            <div class="relative group">
                                <span
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-blue-500 transition-colors z-10">
                                    <i class="ph-bold ph-calendar-blank text-lg"></i>
                                </span>
                                <input type="date" id="input-validade"
                                    class="w-full pl-12 pr-4 py-3 bg-white border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all text-sm font-medium text-slate-600 cursor-pointer hover:border-blue-300">
                            </div>
                        </div>

                        <!-- Formulário Inline Novo Cliente (Estilizado) -->
                        <div id="form-novo-cliente"
                            class="hidden border-t border-slate-100 bg-blue-50/30 p-5 md:p-6 animate-fade-in-down order-2 md:order-3 md:col-span-3">
                            <div class="flex justify-between items-center mb-5">
                                <p class="text-xs font-bold text-blue-800 uppercase flex items-center gap-2">
                                    <span class="bg-blue-100 text-blue-600 p-1 rounded"><i
                                            class="ph-fill ph-user-plus"></i></span> Registo Rápido
                                </p>
                                <button type="button" onclick="toggleNovoCliente()"
                                    class="text-slate-400 hover:text-red-500 transition-colors p-1 hover:bg-red-50 rounded-lg">
                                    <i class="ph-bold ph-x text-lg"></i>
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <input type="text" id="novo-cli-nome" placeholder="Nome Completo *"
                                    class="col-span-1 md:col-span-2 px-4 py-3 text-sm bg-white border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all">
                                <input type="tel" id="novo-cli-phone" placeholder="Telemóvel"
                                    class="px-4 py-3 text-sm bg-white border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all">
                                <input type="email" id="novo-cli-email" placeholder="E-mail"
                                    class="px-4 py-3 text-sm bg-white border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all">
                                <input type="text" id="novo-cli-cpf" placeholder="NIF (Opcional)"
                                    class="px-4 py-3 text-sm bg-white border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all">
                                <input type="text" id="novo-cli-empresa" placeholder="Empresa / Loja"
                                    class="px-4 py-3 text-sm bg-white border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all">
                                <input type="text" id="novo-cli-endereco" placeholder="Morada Completa"
                                    class="col-span-1 md:col-span-2 px-4 py-3 text-sm bg-white border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all">
                            </div>

                            <button type="button" onclick="salvarClienteRapido()"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-3 px-4 rounded-xl transition-all shadow-lg shadow-blue-500/20 flex items-center justify-center gap-2 transform active:scale-[0.98]">
                                <i class="ph-bold ph-check"></i> Guardar Cliente
                            </button>
                        </div>
                    </div>


                </div>

                <!-- Seção Itens -->
                <!-- Seção Itens (Redesenhada & Otimizada) -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <div
                        class="p-5 md:p-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 border-b border-slate-100">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-lg bg-slate-50 border border-slate-100 flex items-center justify-center text-slate-600 flex-shrink-0">
                                <i class="ph-duotone ph-cube text-2xl"></i>
                            </div>
                            <h3 class="text-sm font-bold text-slate-800 leading-tight">
                                PRODUTOS &<br>SERVIÇOS
                            </h3>
                        </div>
                        <button type="button" onclick="abrirModalItens()"
                            class="w-full sm:w-auto bg-slate-800 hover:bg-slate-900 text-white text-xs font-bold px-5 py-2.5 rounded-lg transition-all flex items-center justify-center gap-2 shadow-lg shadow-slate-500/20 active:scale-95 group">
                            <i class="ph-bold ph-plus group-hover:rotate-90 transition-transform"></i> Adicionar Item
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm min-w-[300px]">
                            <thead
                                class="bg-slate-50/50 text-slate-500 font-bold border-b border-slate-100 text-[10px] uppercase tracking-wider">
                                <tr>
                                    <th class="p-3 pl-5">Descrição do Item</th>
                                    <th class="p-3 w-20 text-center">Qtd</th>
                                    <th class="p-3 w-28 text-right">Valor</th>
                                    <th class="p-3 w-10 text-center"></th>
                                </tr>
                            </thead>
                            <tbody id="lista-itens-orcamento" class="divide-y divide-slate-50 bg-white"></tbody>
                        </table>
                    </div>

                    <!-- Empty State -->
                    <div id="empty-itens" class="p-10 text-center text-slate-300 flex flex-col items-center">
                        <i class="ph-duotone ph-package text-4xl mb-3 opacity-40"></i>
                        <span class="text-sm font-medium text-slate-500">A sua lista está vazia</span>
                    </div>

                    <!-- Resumo de Totais -->
                    <div class="p-5 md:p-6 bg-slate-50/50 space-y-2 border-t border-slate-100">
                        <div class="flex justify-between items-center text-xs font-medium text-slate-500">
                            <span class="pl-1">Subtotal Produtos</span>
                            <span class="pr-1" id="subtotal-produtos">--</span>
                        </div>
                        <div class="flex justify-between items-center text-xs font-medium text-slate-500">
                            <span class="pl-1">Mão de Obra</span>
                            <span class="pr-1" id="subtotal-mao-obra">--</span>
                        </div>
                        <div
                            class="flex justify-between items-center text-xs font-medium text-slate-500 pb-3 border-b border-slate-200">
                            <span class="pl-1">Frete / Entregas</span>
                            <span class="pr-1" id="subtotal-frete">--</span>
                        </div>
                        <div class="flex justify-between items-center pt-2">
                            <div class="flex flex-col pl-1">
                                <span
                                    class="text-[10px] font-bold text-slate-400 uppercase tracking-wider leading-none">TOTAL</span>
                                <span
                                    class="text-xs font-bold text-slate-800 uppercase tracking-wider leading-none mt-0.5">CALCULADO</span>
                            </div>
                            <span class="text-2xl font-bold text-blue-600 pr-1 tracking-tight"
                                id="subtotal-display">--</span>
                        </div>
                    </div>
                </div>
                <textarea id="input-descricao" class="hidden"></textarea>
                <input type="hidden" id="input-mao-obra-total" value="0">
                <input type="hidden" id="input-itens-json">
        </div>

        <!-- Seção Pagamento e Valores Redesenhada -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">

            <!-- Coluna 1: Valor e Detalhes -->
            <div class="space-y-6">

                <!-- Box de Valor Principal -->
                <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 shadow-sm">
                    <label class="block text-xs font-bold text-blue-900 mb-3 uppercase flex items-center gap-1">
                        <i class="ph-bold ph-currency-dollar"></i> Valor Total do Orçamento
                    </label>

                    <div class="flex gap-3">
                        <!-- Seletor de Moeda removido conforme solicitação -->


                        <!-- Input de Valor -->
                        <div class="flex-1 relative">
                            <span id="currency-symbol"
                                class="absolute left-4 top-1/2 -translate-y-1/2 text-blue-600 font-bold text-lg select-none">€</span>
                            <input type="text" inputmode="decimal" id="input-valor" placeholder="0,00"
                                class="w-full pl-12 pr-4 py-3.5 bg-white border border-blue-200 rounded-lg text-blue-700 font-bold text-xl focus:outline-none focus:border-blue-500 ring-4 ring-blue-500/5 transition-all shadow-sm">
                        </div>
                    </div>
                </div>

                <!-- Prazo -->
                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-1.5 uppercase">Prazo de Entrega
                        (Dias)</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
                            <i class="ph-bold ph-calendar-check text-lg"></i>
                        </span>
                        <input type="number" id="input-prazo" placeholder="Ex: 15"
                            class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 transition-all font-medium">
                    </div>
                </div>
            </div>

            <!-- Coluna 2: Formas de Pagamento -->
            <div class="bg-white p-6 rounded-xl border border-slate-200 h-fit shadow-sm">
                <h3 class="text-sm font-bold text-slate-800 uppercase mb-4 flex items-center gap-2">
                    <i class="ph-bold ph-wallet text-slate-500"></i> Condições de Pagamento
                </h3>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 mb-1.5 uppercase">Descreva como será o
                        pagamento</label>
                    <textarea id="select-pagamento" rows="4"
                        placeholder="Ex: 50% de entrada e restante na entrega, ou PIX com 5% de desconto..."
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 transition-all font-medium text-sm resize-none"></textarea>
                </div>
            </div>
        </div>

        <div class="pt-8 flex flex-col-reverse sm:flex-row gap-4 border-t border-slate-100">
            <button type="button" onclick="history.back()"
                class="w-full sm:w-auto px-8 py-3.5 bg-white border border-slate-200 text-slate-700 font-bold rounded-xl hover:bg-slate-50 hover:border-slate-300 transition-all active:scale-95 shadow-sm">
                Cancelar
            </button>
            <button type="button" onclick="salvarOrcamentoCompleto()"
                class="w-full sm:flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 px-6 rounded-xl shadow-lg shadow-blue-500/25 active:scale-[0.98] transition-all flex justify-center items-center gap-2.5">
                <i class="ph-bold ph-floppy-disk text-xl"></i> <span>Guardar e Gerar</span>
            </button>
        </div>
        </form>
        </div>
    </main>

    <!-- Modal Seleção de Itens (Redesenhado) -->
    <div id="modal-selecao-item" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="fecharModalItens()">
        </div>
        <div
            class="relative w-full max-w-lg bg-white rounded-2xl shadow-2xl flex flex-col max-h-[90vh] animate-scale-in overflow-hidden">

            <!-- Header -->
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white z-10">
                <h3 class="font-bold text-lg text-slate-800">Adicionar Item</h3>
                <button onclick="fecharModalItens()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="ph-bold ph-x text-lg"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto custom-scrollbar flex-1 bg-slate-50/50">

                <!-- Busca -->
                <div class="relative mb-4">
                    <i class="ph-bold ph-magnifying-glass absolute left-4 top-3.5 text-slate-400 text-lg"></i>
                    <input type="text" id="busca-item-modal" onkeyup="filtrarItensModal()"
                        placeholder="Buscar produto ou serviço..."
                        class="w-full pl-11 pr-4 py-3 bg-white border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 shadow-sm text-sm transition-all">
                </div>

                <!-- Toggle Form Link -->
                <div class="flex justify-between items-center mb-4 px-1">
                    <button type="button" onclick="toggleNovoItem()" id="btn-novo-item-text"
                        class="text-xs font-bold text-blue-600 hover:text-blue-700 flex items-center gap-1 transition-colors">
                        <i class="ph-bold ph-plus-circle"></i> Registar Novo Item
                    </button>
                    <button type="button" onclick="recarregarItensModal()"
                        class="text-xs font-bold text-slate-400 hover:text-slate-600 flex items-center gap-1 transition-colors">
                        <i class="ph-bold ph-arrows-clockwise"></i> Atualizar
                    </button>
                </div>

                <!-- Form Cadastro Rápido (Estilo Green) -->
                <div id="form-novo-item"
                    class="hidden mb-6 bg-green-50/50 border border-green-100 rounded-xl p-5 animate-fade-in-down">
                    <p class="text-[10px] font-bold text-green-700 uppercase tracking-wider mb-3">Registo Rápido de
                        Item</p>

                    <div class="space-y-3">
                        <input type="text" id="novo-item-nome" placeholder="Nome do item *"
                            class="w-full px-4 py-2.5 text-sm bg-white border border-green-200/60 rounded-lg focus:outline-none focus:border-green-500 shadow-sm placeholder:text-slate-400 font-medium">

                        <div class="grid grid-cols-2 gap-3">
                            <div class="relative">
                                <select id="novo-item-tipo" onchange="toggleNovoItemTipo()"
                                    class="w-full px-4 py-2.5 text-sm bg-white border border-green-200/60 rounded-lg focus:outline-none focus:border-green-500 appearance-none font-bold text-slate-600 cursor-pointer shadow-sm disabled:opacity-50">
                                    <option value="Serviço">Serviço</option>
                                    <option value="Produto">Produto</option>
                                </select>
                                <div
                                    class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                    <i class="ph-bold ph-caret-down"></i>
                                </div>
                            </div>
                            <div class="relative">
                                <span
                                    class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-xs">€</span>
                                <input type="text" inputmode="decimal" id="novo-item-preco" placeholder="Preço *"
                                    class="w-full pl-8 pr-4 py-2.5 text-sm bg-white border border-green-200/60 rounded-lg focus:outline-none focus:border-green-500 shadow-sm placeholder:text-slate-400 font-bold text-slate-700">
                            </div>
                        </div>

                        <!-- Campos Dinâmicos Compactos -->
                        <div id="novo-box-mao-obra" class="w-full">
                            <label class="text-[10px] font-bold text-green-700 uppercase mb-1 ml-1 block">Custo Mão de
                                Obra</label>
                            <div class="relative">
                                <span
                                    class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-xs">€</span>
                                <input type="text" inputmode="decimal" id="novo-item-mao-obra" placeholder="0,00"
                                    class="w-full pl-8 pr-4 py-2.5 text-sm bg-white border border-green-200/60 rounded-lg focus:outline-none focus:border-green-500 shadow-sm placeholder:text-slate-400">
                            </div>
                        </div>
                        <div id="novo-box-frete" class="w-full hidden">
                            <label class="text-[10px] font-bold text-green-700 uppercase mb-1 ml-1 block">Custo
                                Frete</label>
                            <div class="relative">
                                <span
                                    class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-xs">€</span>
                                <input type="text" inputmode="decimal" id="novo-item-frete" placeholder="0,00"
                                    class="w-full pl-8 pr-4 py-2.5 text-sm bg-white border border-green-200/60 rounded-lg focus:outline-none focus:border-green-500 shadow-sm placeholder:text-slate-400">
                            </div>
                        </div>

                        <div>
                            <textarea id="novo-item-descricao" placeholder="Descrição detalhada do item (Opcional)"
                                rows="3"
                                class="w-full px-4 py-2.5 text-sm bg-white border border-green-200/60 rounded-lg focus:outline-none focus:border-green-500 shadow-sm placeholder:text-slate-400 resize-none"></textarea>
                        </div>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="salvarItemRapido()"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2.5 px-4 rounded-lg transition-all shadow-lg shadow-green-500/20 active:scale-[0.98] flex items-center justify-center gap-2">
                            <i class="ph-bold ph-check"></i> Guardar e Adicionar
                        </button>
                        <button type="button" onclick="toggleNovoItem()"
                            class="px-4 py-2.5 bg-white border border-slate-200 text-slate-600 text-xs font-bold rounded-lg hover:bg-slate-50 transition-colors">
                            Cancelar
                        </button>
                    </div>
                </div>

                <!-- Lista de Itens -->
                <ul id="lista-itens-disponiveis" class="space-y-3 pb-4">
                    <li class="p-8 text-center text-slate-400 flex flex-col items-center">
                        <i class="ph-bold ph-spinner animate-spin text-2xl mb-2"></i> A carregar catálogo...
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Navegação Inferior Premium -->
    <nav
        class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-md border border-slate-200 rounded-full shadow-2xl p-2 flex items-center gap-1 z-50 whitespace-nowrap scale-90 md:scale-100 transition-all origin-bottom print:hidden">
        <a href="dashboard.html"
            class="flex items-center gap-2 px-4 py-2.5 text-slate-500 hover:bg-slate-100 rounded-full font-medium text-sm transition-all hover:text-blue-600">
            <i class="ph-bold ph-house text-lg"></i> <span class="hidden md:inline">Dashboard</span>
        </a>
        <a href="orcamentos.html"
            class="flex items-center gap-2 px-4 py-2.5 text-slate-500 hover:bg-slate-100 rounded-full font-medium text-sm transition-all hover:text-blue-600">
            <i class="ph-bold ph-file-text text-lg"></i> <span class="hidden md:inline">Orçamentos</span>
        </a>
        <a href="criar-orcamento.html"
            class="flex items-center gap-2 px-4 py-2.5 bg-blue-600 text-white rounded-full font-bold text-sm shadow-lg shadow-blue-500/30 transition-all">
            <i class="ph-bold ph-plus text-lg"></i> <span class="hidden md:inline">Novo</span>
        </a>
        <a href="clientes.html"
            class="flex items-center gap-2 px-4 py-2.5 text-slate-500 hover:bg-slate-100 rounded-full font-medium text-sm transition-all hover:text-blue-600">
            <i class="ph-bold ph-users text-lg"></i> <span class="hidden md:inline">Clientes</span>
        </a>
        <a href="catalogo.html"
            class="flex items-center gap-2 px-4 py-2.5 text-slate-500 hover:bg-slate-100 rounded-full font-medium text-sm transition-all hover:text-blue-600">
            <i class="ph-bold ph-cube text-lg"></i> <span class="hidden md:inline">Itens</span>
        </a>
        <a href="ajustes.html"
            class="flex items-center gap-2 px-4 py-2.5 text-slate-500 hover:bg-slate-100 rounded-full font-medium text-sm transition-all hover:text-blue-600">
            <i class="ph-bold ph-gear text-lg"></i> <span class="hidden md:inline">Config</span>
        </a>
    </nav>

    <script src="app.js?v=1000"></script>
    <script>
        let itensOrcamento = [];
        let itensCatalogo = [];

        // Lógica de manipulação de itens
        function carregarItensModal() {
            const ul = document.getElementById('lista-itens-disponiveis');
            // Elemento 'sb' vem do app.js que carrega globalmente (após DOMContentLoaded, mas onclick pode chamar depois)
            // Para garantir: verifica se sb existe. Se não, espera ou tenta pegar de window.supabase
            if (!window.supabase && !sb) return ul.innerHTML = '<li class="p-4 text-center text-red-400">Erro: Conexão DB.</li>';

            // Reutiliza função do app.js se possível, mas aqui é lógica local de UI
            // Vamos fazer a query direta pro supabase caso app.js já tenha inicializado 'sb'
            if (itensCatalogo.length > 0) { renderizarListaModal(itensCatalogo); return; }

            const fetchItens = async () => {
                const { data } = await sb.from('itens').select('*').order('nome');
                itensCatalogo = data || [];
                renderizarListaModal(itensCatalogo);
            };
            fetchItens();
        }

        function renderizarListaModal(lista) {
            const ul = document.getElementById('lista-itens-disponiveis');
            ul.innerHTML = '';
            if (lista.length === 0) { ul.innerHTML = '<li class="p-8 text-center text-slate-400 flex flex-col items-center"><i class="ph-duotone ph-magnifying-glass text-2xl mb-2 opacity-50"></i> Nenhum item encontrado.</li>'; return; }

            lista.forEach(item => {
                const li = document.createElement('li');
                li.className = 'p-3 hover:bg-slate-50 border border-slate-100 rounded-lg cursor-pointer flex justify-between items-center group transition-all';
                li.onclick = () => selecionarItem(item);

                const precoFormatado = parseFloat(item.preco).toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' });

                li.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-bold text-slate-800 text-sm group-hover:text-blue-700 transition-colors">${item.nome}</span>
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">${item.tipo || 'Item'}</span>
                    </div>
                    <div class="text-right">
                        <span class="block font-bold text-slate-900 text-sm">${precoFormatado}</span>
                        <span class="text-[10px] text-blue-600 font-bold opacity-0 group-hover:opacity-100 transition-opacity flex justify-end items-center gap-1">
                            Adicionar <i class="ph-bold ph-plus"></i>
                        </span>
                    </div>`;
                ul.appendChild(li);
            });
        }


        function selecionarItem(item) {
            // Clona e adiciona default qtd 1
            const novo = { ...item, qtd: 1 };
            itensOrcamento.push(novo);
            atualizarTabelaItens();
            fecharModalItens();
            const btn = document.querySelector('button[onclick="abrirModalItens()"]');
            btn.innerHTML = `<i class="ph-bold ph-check"></i> Item Adicionado`;
            setTimeout(() => { btn.innerHTML = `<i class="ph-bold ph-plus"></i> Adicionar Item`; }, 1000);
        }

        function removerItemOrcamento(index) {
            itensOrcamento.splice(index, 1);
            atualizarTabelaItens();
        }

        function atualizarQuantidade(index, novaQtd) {
            let qtd = parseInt(novaQtd);
            if (isNaN(qtd) || qtd < 1) qtd = 1;
            itensOrcamento[index].qtd = qtd;
            atualizarTabelaItens();
        }

        function atualizarTabelaItens() {
            const tbody = document.getElementById('lista-itens-orcamento');
            const empty = document.getElementById('empty-itens');
            const totalDisplay = document.getElementById('subtotal-display');
            const subtotalProdutos = document.getElementById('subtotal-produtos');
            const subtotalMaoObra = document.getElementById('subtotal-mao-obra');
            const subtotalFrete = document.getElementById('subtotal-frete');

            const inputValor = document.getElementById('input-valor');
            const inputDesc = document.getElementById('input-descricao');
            const inputMaoObraTotal = document.getElementById('input-mao-obra-total');
            const inputJson = document.getElementById('input-itens-json');

            tbody.innerHTML = '';
            let totalProd = 0;
            let totalMO = 0;
            let totalFrete = 0;
            let descricaoTexto = '';

            if (itensOrcamento.length === 0) { empty.classList.remove('hidden'); }
            else {
                empty.classList.add('hidden');
                itensOrcamento.forEach((item, index) => {
                    const qtd = item.qtd || 1;
                    const preco = Number(item.preco) || 0;
                    const maoObra = Number(item.mao_de_obra) || 0;
                    const frete = Number(item.frete) || 0;

                    const subProd = preco * qtd;
                    const subMO = maoObra * qtd;
                    const subFrete = frete * qtd;

                    totalProd += subProd;
                    totalMO += subMO;
                    totalFrete += subFrete;

                    const valorTotalItem = subProd + subMO + subFrete;

                    descricaoTexto += `• ${qtd}x ${item.nome} - ${formatarMoeda(subProd)}`;
                    if (subMO > 0) descricaoTexto += ` + M.O: ${formatarMoeda(subMO)}`;
                    if (subFrete > 0) descricaoTexto += ` + Frete: ${formatarMoeda(subFrete)}`;
                    if (item.descricao) descricaoTexto += `\n  (${item.descricao})`;
                    descricaoTexto += '\n';

                    tbody.innerHTML += `
                    <tr class="group hover:bg-slate-50 border-b border-slate-50 last:border-0">
                        <td class="p-3 pl-5">
                            <div class="font-bold text-slate-700 text-sm">${item.nome}</div>
                            <div class="text-[10px] text-slate-400 truncate max-w-[120px] leading-tight">${item.descricao || ''}</div>
                        </td>
                        <td class="p-3 text-center">
                            <input type="number" min="1" value="${qtd}" onchange="atualizarQuantidade(${index}, this.value)" 
                                class="w-12 p-1 text-center bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold focus:border-blue-500 focus:outline-none focus:bg-white transition-all">
                        </td>
                        <td class="p-3 text-right font-bold text-slate-700 text-sm">
                            ${formatarMoeda(valorTotalItem)}
                        </td>
                        <td class="p-3 text-center">
                            <button type="button" onclick="removerItemOrcamento(${index})" class="text-slate-300 hover:text-red-500 p-1.5 rounded-lg hover:bg-red-50 transition-colors">
                                <i class="ph-bold ph-trash"></i>
                            </button>
                        </td>
                    </tr>`;
                });
            }

            const total = totalProd + totalMO + totalFrete;

            // Atualiza displays com moeda correta
            subtotalProdutos.innerText = formatarMoeda(totalProd);
            subtotalMaoObra.innerText = formatarMoeda(totalMO);
            if (subtotalFrete) subtotalFrete.innerText = formatarMoeda(totalFrete);
            totalDisplay.innerText = formatarMoeda(total);

            // Campos ocultos para salvar
            inputValor.value = total.toFixed(2).replace('.', ',');
            inputMaoObraTotal.value = totalMO.toFixed(2);
            inputDesc.value = descricaoTexto.trim();
            inputJson.value = JSON.stringify(itensOrcamento);
        }

        // ===================================
        // FUNÇÕES LOCAIS DE ITEM RÁPIDO
        // ===================================
        function toggleNovoItem() {
            const form = document.getElementById('form-novo-item');
            const btn = document.getElementById('btn-novo-item-text');
            if (form) form.classList.toggle('hidden');
            if (btn) btn.innerHTML = form.classList.contains('hidden') ? '<i class="ph-bold ph-plus-circle"></i> Registar Novo Item' : '<i class="ph-bold ph-minus-circle"></i> Cancelar Registo';
            if (!form.classList.contains('hidden')) {
                setTimeout(() => document.getElementById('novo-item-nome')?.focus(), 100);
            }
        }

        function toggleNovoItemTipo() {
            const tipo = document.getElementById('novo-item-tipo').value;
            const boxMO = document.getElementById('novo-box-mao-obra');
            const boxFrete = document.getElementById('novo-box-frete');
            if (tipo === 'Serviço') {
                boxMO.classList.remove('hidden');
                boxFrete.classList.add('hidden');
            } else {
                boxMO.classList.add('hidden');
                boxFrete.classList.remove('hidden');
            }
        }

        async function salvarItemRapido() {
            const nome = document.getElementById('novo-item-nome').value.trim();
            const tipo = document.getElementById('novo-item-tipo').value;
            const precoObj = document.getElementById('novo-item-preco').value.replace(',', '.');
            const moObj = document.getElementById('novo-item-mao-obra').value.replace(',', '.');
            const freteObj = document.getElementById('novo-item-frete').value.replace(',', '.');
            const descricao = document.getElementById('novo-item-descricao').value.trim();

            if (!nome || !precoObj) return alert("Preencha Nome e Preço.");

            const preco = parseFloat(precoObj);
            const mao_de_obra = parseFloat(moObj) || 0;
            const frete = parseFloat(freteObj) || 0;

            const btn = document.querySelector('button[onclick="salvarItemRapido()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> A guardar...';
            btn.disabled = true;

            try {
                const { data: { user } } = await sb.auth.getUser();
                if (!user) throw new Error("Usuário não logado.");

                const payload = {
                    user_id: user.id,
                    nome,
                    tipo,
                    preco,
                    mao_de_obra,
                    frete,
                    descricao
                };

                const { data, error } = await sb.from('itens').insert([payload]).select();
                if (error) throw error;

                // Sucesso
                alert("Item adicionado ao catálogo! ✅");

                // Limpa form
                document.getElementById('novo-item-nome').value = '';
                document.getElementById('novo-item-preco').value = '';
                document.getElementById('novo-item-mao-obra').value = '';
                document.getElementById('novo-item-frete').value = '';
                document.getElementById('novo-item-descricao').value = '';

                toggleNovoItem();

                // Recarrega lista
                recarregarItensModal();

            } catch (e) {
                console.error(e);
                alert("Erro ao salvar item: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function recarregarItensModal() {
            itensCatalogo = [];
            const ul = document.getElementById('lista-itens-disponiveis');
            ul.innerHTML = '<li class="p-8 text-center text-slate-400 flex flex-col items-center"><i class="ph-bold ph-spinner animate-spin text-2xl mb-2"></i> A carregar catálogo...</li>';
            carregarItensModal();
        }

        function filtrarItensModal() {
            const termo = document.getElementById('busca-item-modal').value.toLowerCase();
            const filtrados = itensCatalogo.filter(i => i.nome.toLowerCase().includes(termo) || (i.descricao && i.descricao.toLowerCase().includes(termo)));
            renderizarListaModal(filtrados);
        }

        function abrirModalItens() {
            document.getElementById('modal-selecao-item').classList.remove('hidden');
            if (itensCatalogo.length === 0) {
                carregarItensModal();
            } else {
                // Re-renderiza com a moeda atual se já tiver itens carregados
                renderizarListaModal(itensCatalogo);
            }
            document.getElementById('busca-item-modal').focus();
        }
        function fecharModalItens() { document.getElementById('modal-selecao-item').classList.add('hidden'); }
        function recarregarItensModal() { itensCatalogo = []; carregarItensModal(); }

        async function carregarDadosEmpresaCriacao() {
            try {
                const { data: { user } } = await sb.auth.getUser();
                if (user) {
                    const { data: empresa } = await sb.from('empresas').select('moeda_padrao').eq('user_id', user.id).maybeSingle();
                    if (empresa) {
                        /* Removida lógica de moeda */
                    }
                }
            } catch (e) { console.error("Erro ao carregar dados da empresa", e); }
        }

        // Removida a função togglePixFields pois não é mais usada

        // ========== CADASTRO RÁPIDO DE CLIENTE ==========
        function toggleNovoCliente() {
            const form = document.getElementById('form-novo-cliente');
            const btn = document.getElementById('btn-novo-cliente-text');
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.innerText = 'Fechar Formulário';
                document.getElementById('novo-cli-nome').focus();
            } else {
                form.classList.add('hidden');
                btn.innerText = 'Novo Cliente';
            }
        }

        async function salvarClienteRapido() {
            const nome = document.getElementById('novo-cli-nome').value.trim();
            const phone = document.getElementById('novo-cli-phone').value.trim();
            const email = document.getElementById('novo-cli-email').value.trim();
            const empresa = document.getElementById('novo-cli-empresa').value.trim();
            const cpf = document.getElementById('novo-cli-cpf').value.trim();
            const endereco = document.getElementById('novo-cli-endereco').value.trim();

            if (!nome) return alert("Digite o nome do cliente.");

            try {
                const { data: { user } } = await sb.auth.getUser();
                const { data, error } = await sb.from('clientes').insert([{ nome, phone, email, empresa, cpf, endereco, user_id: user.id }]).select();
                if (error) throw error;

                // Atualiza o select e seleciona o novo cliente
                await carregarSelectClientes();
                document.getElementById('select-cliente').value = nome;

                // Limpa e fecha o formulário
                document.getElementById('novo-cli-nome').value = '';
                document.getElementById('novo-cli-phone').value = '';
                document.getElementById('novo-cli-email').value = '';
                document.getElementById('novo-cli-empresa').value = '';
                document.getElementById('novo-cli-cpf').value = '';
                document.getElementById('novo-cli-endereco').value = '';
                toggleNovoCliente();

                alert("Cliente registado com sucesso! ✅");
            } catch (err) {
                alert("Erro ao guardar cliente: " + err.message);
            }
        }

        // ========== CADASTRO RÁPIDO DE ITEM ==========
        function toggleNovoItem() {
            const form = document.getElementById('form-novo-item');
            const btn = document.getElementById('btn-novo-item-text');
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.innerText = 'Fechar Formulário';
                document.getElementById('novo-item-nome').focus();
            } else {
                form.classList.add('hidden');
                btn.innerText = 'Registar Novo Item';
            }
        }

        function toggleNovoItemTipo() {
            const tipo = document.getElementById('novo-item-tipo').value;
            const boxMO = document.getElementById('novo-box-mao-obra');
            const boxFrete = document.getElementById('novo-box-frete');

            if (tipo === 'Produto') {
                boxMO.classList.add('hidden');
                boxFrete.classList.remove('hidden');
            } else {
                boxMO.classList.remove('hidden');
                boxFrete.classList.add('hidden');
            }
        }

        async function salvarItemRapido() {
            const nome = document.getElementById('novo-item-nome').value.trim();
            const tipo = document.getElementById('novo-item-tipo').value;
            let preco = document.getElementById('novo-item-preco').value.replace(',', '.');
            let maoObra = document.getElementById('novo-item-mao-obra').value.replace(',', '.') || '0';
            let frete = document.getElementById('novo-item-frete').value.replace(',', '.') || '0';
            const descricao = document.getElementById('novo-item-descricao').value.trim();

            if (tipo === 'Produto') maoObra = 0;
            if (tipo === 'Serviço') frete = 0;

            if (!nome || !preco) return alert("Preencha nome e preço do item.");

            preco = parseFloat(preco);
            maoObra = parseFloat(maoObra);

            if (isNaN(preco)) return alert("Preço inválido.");

            try {
                const { data: { user } } = await sb.auth.getUser();
                const { data, error } = await sb.from('itens').insert([{ nome, tipo, preco, mao_de_obra: maoObra, frete, descricao, user_id: user.id }]).select();
                if (error) throw error;

                // Adiciona o item ao orçamento atual
                const novoItem = { id: data[0].id, nome, tipo, preco, mao_de_obra: maoObra, frete, descricao };
                selecionarItem(novoItem);

                // Limpa o formulário
                document.getElementById('novo-item-nome').value = '';
                document.getElementById('novo-item-preco').value = '';
                document.getElementById('novo-item-mao-obra').value = '';
                document.getElementById('novo-item-frete').value = '';
                document.getElementById('novo-item-descricao').value = '';
                toggleNovoItem();

                // Atualiza lista do modal
                itensCatalogo = [];
                carregarItensModal();

            } catch (err) {
                alert("Erro ao salvar item: " + err.message);
            }
        }

        // Máscaras para Cadastro Rápido
        // Máscaras (Adaptadas para Portugal)
        const mascaraDoc = (val) => {
            val = val.replace(/\D/g, "").slice(0, 9); // NIF tem 9 dígitos
            // Formato 123 456 789
            return val.replace(/(\d{3})(\d)/, "$1 $2")
                .replace(/(\d{3}) (\d{3})(\d)/, "$1 $2 $3");
        };

        const mascaraTel = (val) => {
            val = val.replace(/\D/g, "").slice(0, 9); // Tlm 9 dígitos
            // Formato 912 345 678
            return val.replace(/(\d{3})(\d)/, "$1 $2")
                .replace(/(\d{3}) (\d{3})(\d)/, "$1 $2 $3");
        };

        document.addEventListener('DOMContentLoaded', () => {

            carregarDadosEmpresaCriacao();
            const novoCliCpf = document.getElementById('novo-cli-cpf');
            const novoCliPhone = document.getElementById('novo-cli-phone');

            if (novoCliCpf) novoCliCpf.addEventListener('input', (e) => e.target.value = mascaraDoc(e.target.value));
            if (novoCliPhone) novoCliPhone.addEventListener('input', (e) => e.target.value = mascaraTel(e.target.value));
            if (novoCliPhone) novoCliPhone.addEventListener('input', (e) => e.target.value = mascaraTel(e.target.value));

            atualizarSimboloMoeda(); // Inicializa símbolo
        });

        function atualizarSimboloMoeda() {
            const select = document.getElementById('select-moeda');
            const symbolSpan = document.getElementById('currency-symbol');
            if (select && symbolSpan) {
                const map = { 'EUR': '€', 'BRL': 'R$', 'USD': '$' };
                symbolSpan.innerText = map[select.value] || '€';
            }
        }
    </script>
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-scale-in {
            animation: scaleIn 0.2s ease-out;
        }
    </style>
</body>

</html>