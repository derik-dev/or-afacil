<!DOCTYPE html>
<html lang="pt-pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orçamento • Visualização</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #F0F4F8; /* Cor de fundo original */
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .has-logo #default-logo {
            display: none !important;
        }

        #tbody-itens tr td {
            color: #000000;
        }

        /* --- CORREÇÃO DO CORTE NO PDF --- */
        @media print {
            body {
                background: white;
                margin: 0;
                padding: 0;
            }
            .no-print {
                display: none !important;
            }
            #documento-pdf {
                width: 100% !important; /* Se ajusta ao papel, evita corte fixo */
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
            }
            /* Esconde scrollbars que as vezes causam o corte */
            ::-webkit-scrollbar {
                display: none;
            }
        }
        /* -------------------------------- */

        /* Visual na tela (Computador/Celular) */
        #documento-pdf {
            width: 100%;
            max-width: 210mm; /* Mantém a proporção A4 na tela */
            margin: 0 auto;
            background: white;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center py-8 pb-32">

    <div class="fixed top-4 bg-white/95 backdrop-blur shadow-lg border border-slate-200 px-6 py-3 rounded-full flex gap-4 items-center z-50 no-print transition-all hover:scale-[1.02]">
        <a href="dashboard.html" class="flex items-center gap-2 text-blue-900 hover:text-blue-700 font-bold text-sm mr-2 border-r border-gray-300 pr-4">
            <i class="ph-bold ph-hexagon text-lg text-blue-600"></i> <span class="hidden sm:inline">OrçaFácil</span>
        </a>
        <a href="orcamentos.html" class="flex items-center gap-2 text-gray-500 hover:text-blue-600 font-bold text-sm">
            <i class="ph-bold ph-arrow-left"></i> Voltar
        </a>
        <div class="h-4 w-px bg-gray-300 hidden md:block"></div>
        <button onclick="baixarPDF()" class="flex items-center gap-2 text-black font-bold text-sm hover:underline">
            <i class="ph-bold ph-download-simple"></i> Descarregar PDF
        </button>
        <div class="h-4 w-px bg-gray-300 hidden md:block"></div>
        <button onclick="enviarWhatsApp()" class="flex items-center gap-2 text-green-600 font-bold text-sm hover:underline">
            <i class="ph-bold ph-whatsapp-logo"></i> <span class="hidden sm:inline">Enviar via WhatsApp</span>
        </button>
    </div>

    <main id="documento-pdf" class="relative shadow-2xl print-shadow text-black overflow-hidden mt-16 md:mt-0 p-8 md:p-12">

        <div id="pdf-header-bar" class="flex justify-between items-start gap-3 border-b-2 border-black pb-6 mb-6">
            <div class="text-left flex flex-col items-start flex-shrink-0">
                <div id="logo-container" class="bg-white mb-2 relative h-28 w-48 flex items-center justify-start overflow-hidden">
                    <img id="empresa-logo-img" src="" class="h-full object-contain object-left hidden">
                    <div id="default-logo" class="h-full w-full flex items-center justify-start text-black">
                        <i class="ph-bold ph-hexagon text-6xl"></i>
                    </div>
                </div>
                <h2 class="font-extrabold text-xl text-black mb-1 leading-none" id="empresa-nome">Sua Empresa</h2>
                <div class="text-[10px] text-gray-600 space-y-0.5 font-medium">
                    <p id="empresa-end">Morada Completa, 000 - Cidade/Distrito</p>
                    <p><span id="empresa-doc" class="font-semibold">NIF: 123456789</span> • <span id="empresa-tel">Tel: +351 ...</span></p>
                </div>
            </div>

            <div class="flex-1 text-right flex flex-col items-end gap-3 pt-2">
                <div>
                    <h1 class="text-4xl font-extrabold tracking-tight mb-0 text-black leading-none">ORÇAMENTO</h1>
                    <p class="text-gray-500 text-[10px] font-bold uppercase tracking-[0.2em] mt-1">Proposta Comercial</p>
                </div>
                <div id="box-observacoes" class="bg-gray-50 rounded-lg border border-gray-100 p-2.5 w-full max-w-[280px] text-left mt-2">
                    <h4 class="font-bold text-[9px] text-gray-400 mb-1 uppercase tracking-wider">Observações</h4>
                    <div class="text-[10px] text-gray-700 space-y-1 leading-tight font-medium">
                        <p id="obs-pagamento" class="hidden">• Pagamento conf. indicado.</p>
                        <p id="obs-prazo" class="hidden">• Prazo: <span id="obs-prazo-dias" class="font-bold text-black"></span> dias úteis.</p>
                        <p class="text-gray-500">• Validade da proposta: 15 dias.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-8 mb-8 border-b border-gray-100 pb-8">
            <div>
                <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 pb-1 border-b border-gray-100">Cliente</h3>
                <div class="grid grid-cols-[auto_1fr] gap-x-3 gap-y-1.5 text-xs text-black items-baseline">
                    <span class="font-bold text-gray-500 text-right">Nome:</span><span id="cli-nome" class="font-bold text-sm">...</span>
                    <span class="font-bold text-gray-500 text-right">Empresa:</span><span id="cli-sub-empresa" class="text-gray-800">-</span>
                    <span class="font-bold text-gray-500 text-right">NIF:</span><span id="cli-cpf" class="text-gray-800 font-mono text-[11px]">-</span>
                    <span class="font-bold text-gray-500 text-right">Email:</span><span id="cli-email" class="text-gray-800">-</span>
                    <span class="font-bold text-gray-500 text-right">Tel:</span><span id="cli-tel" class="text-gray-800">-</span>
                    <span class="font-bold text-gray-500 text-right">Morada:</span><span id="cli-endereco" class="text-gray-800 leading-tight">-</span>
                </div>
            </div>
            <div>
                <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 pb-1 border-b border-gray-100">Detalhes</h3>
                <div class="grid grid-cols-[auto_1fr] gap-x-3 gap-y-1.5 text-xs text-black items-baseline">
                    <span class="font-bold text-gray-500 text-right">Orçamento:</span><span id="orc-id" class="font-bold text-sm">#0000</span>
                    <span class="font-bold text-gray-500 text-right">Data:</span><span id="orc-data" class="text-gray-800">--/--/----</span>
                    <span class="font-bold text-gray-500 text-right">Validade:</span><span id="orc-validade" class="text-gray-800">15 dias</span>
                    <span class="font-bold text-gray-500 text-right">Status:</span><span id="orc-status" class="font-bold text-black bg-gray-100 px-2 py-0.5 rounded text-[10px] uppercase tracking-wider">Pendente</span>
                </div>
            </div>
        </div>

        <table class="w-full text-xs">
            <thead>
                <tr id="pdf-table-header" class="text-black border-0">
                    <th class="text-left py-2 font-bold uppercase tracking-wider text-[11px] pl-2 rounded-l-lg">Descrição / Item</th>
                    <th class="text-right py-2 font-bold uppercase tracking-wider w-36 text-[11px] pr-2 rounded-r-lg">Valor Total</th>
                </tr>
            </thead>
            <tbody id="tbody-itens" class="divide-y divide-gray-100 bg-white text-black">
            </tbody>
        </table>

        <div class="mt-8 border-t border-gray-200 pt-6">
            <div class="flex justify-between items-end">
                
                <div class="flex-1 max-w-[50%] space-y-6">
                    <div id="box-pix" class="hidden bg-slate-50 rounded-xl border border-slate-200 p-4 flex items-center gap-4">
                        <div class="flex-1 min-w-0">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Dados Bancários / PIX</p>
                            <p class="font-mono text-sm font-bold text-slate-900 truncate" id="orc-chave-pix">---</p>
                        </div>
                        <div id="qr-code-pix-container" class="hidden bg-white p-1 rounded border border-gray-100 flex-shrink-0">
                            <img id="qr-code-pix-img" class="h-14 w-14 object-contain">
                        </div>
                    </div>

                    <div class="mt-8">
                        <div class="border-b border-black w-64 mb-2"></div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Assinatura</p>
                    </div>
                </div>

                <div class="w-64 space-y-2 text-right">
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-500 font-bold uppercase tracking-tighter">Subtotal</span>
                        <span id="orc-subtotal" class="font-mono font-bold text-gray-900">€ 0,00</span>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-500 font-bold uppercase tracking-tighter">Desconto</span>
                        <span id="orc-desconto" class="font-mono font-bold text-red-600">- € 0,00</span>
                    </div>
                    <div class="border-t-2 border-black pt-3 mt-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-black uppercase text-black">Total</span>
                            <span id="orc-valor" class="text-2xl font-black text-blue-600">€ 0,00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <section class="mt-12 pt-6 border-t border-gray-100">
            <h4 class="font-bold text-[9px] text-gray-400 mb-2 uppercase tracking-widest">Termos e Condições</h4>
            <div class="text-[10px] text-gray-500 grid grid-cols-2 gap-4 font-medium leading-relaxed">
                <div>• Este orçamento tem validade de 15 dias.</div>
                <div>• Serviços adicionais serão cobrados à parte.</div>
            </div>
        </section>

        <footer class="bg-gray-50 border-t border-gray-100 p-3 text-center text-[10px] text-gray-400 mt-12 rounded-lg">
            <p class="font-semibold text-gray-600">Obrigado pela preferência!</p>
        </footer>
    </main>

    <script src="app.js?v=1002"></script>
    <script>
        // Lógica visual do logo
        const logoImg = document.getElementById('empresa-logo-img');
        const logoContainer = document.getElementById('logo-container');
        const observer = new MutationObserver(() => {
            if (!logoImg.classList.contains('hidden')) logoContainer.classList.add('has-logo');
        });
        observer.observe(logoImg, { attributes: true });

        // Função corrigida para não cortar o PDF
        function baixarPDF() {
            const element = document.getElementById('documento-pdf');
            
            // Opções ajustadas para evitar corte lateral
            const opt = {
                margin: [5, 10, 5, 10], // Margem de segurança (Topo, Dir, Baixo, Esq)
                filename: `Orcamento.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, // Boa qualidade sem estourar memória
                    useCORS: true,
                    scrollX: 0,
                    scrollY: 0
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Gera o PDF
            html2pdf().set(opt).from(element).save();
        }

        function enviarWhatsApp() {
            const tel = document.getElementById('cli-tel')?.innerText.replace(/\D/g, '') || '';
            const msg = encodeURIComponent(`Olá! Segue o link do seu orçamento.`);
            window.open(`https://wa.me/${tel}?text=${msg}`, '_blank');
        }
    </script>
</body>
</html>